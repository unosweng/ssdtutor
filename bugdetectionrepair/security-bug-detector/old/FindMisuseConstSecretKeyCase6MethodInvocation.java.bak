/**
 */
package visitor.findmisuse.constsecretkeycases;

import java.util.ArrayList;
import java.util.List;

import org.eclipse.jdt.core.dom.ASTVisitor;
import org.eclipse.jdt.core.dom.ClassInstanceCreation;
import org.eclipse.jdt.core.dom.MethodDeclaration;
import org.eclipse.jdt.core.dom.MethodInvocation;
import org.eclipse.jdt.core.dom.QualifiedName;
import org.eclipse.jdt.core.dom.SimpleName;
import org.eclipse.jdt.core.dom.VariableDeclarationFragment;
import org.eclipse.jdt.core.dom.VariableDeclarationStatement;
import org.eclipse.jface.text.IDocument;

import visitor.DetectionASTVisitor;
import visitor.FindMisuse;

/**
 * @since J2SE-1.8 (Java SE 8 [1.8.0_71])
 */
public class FindMisuseConstSecretKeyCase6MethodInvocation extends FindMisuse {
   DetectionASTVisitor detector;
   QualifiedName qNameToTrack;
   ClassInstanceCreation ciNameToTrack;
   String javaFilePathToTrack;
   IDocument docToTrack;
   List<MethodInvocation> methodInArgs = new ArrayList<>();
   List<VariableDeclarationStatement> varDecls = new ArrayList<>();

   public FindMisuseConstSecretKeyCase6MethodInvocation(FindMisuseConstSecretKeyDetecter detector) {
      this.detector = detector;
   }

   boolean checkCase6_MethodInvocation(MethodDeclaration metDec, ClassInstanceCreation ciCre) {
      List<?> arguments = ciCre.arguments();
      for (Object iObj : arguments) {
         if (iObj instanceof MethodInvocation) {
            MethodInvocation imInvoc = (MethodInvocation) iObj;
            methodInArgs.add(imInvoc);
         }
      }

      metDec.accept(new ASTVisitor() {
         @Override
         public boolean visit(VariableDeclarationStatement vds) {
            List<?> fragments = vds.fragments();
            for (Object iObj : fragments) {
               if (iObj instanceof VariableDeclarationFragment) {
                  VariableDeclarationFragment vdf = (VariableDeclarationFragment) iObj;

                  for (MethodInvocation imInvoc : methodInArgs) {
                     SimpleName sn = (SimpleName) imInvoc.getExpression();
                     if (sn.resolveBinding().equals(vdf.getName().resolveBinding())) {
                        varDecls.add(vds);
                     }
                  }
               }
            }
            return true;
         }
      });

      if (!varDecls.isEmpty()) {
         return true;
      }
      return false;
   }

   void displayMap() {
      for (VariableDeclarationStatement vds : varDecls) {
         System.out.println("\t VariableDeclarationStatement:" + vds.toString());
      }
   }
}